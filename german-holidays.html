<!DOCTYPE HTML>
<script type="text/html" data-template-name="german-holidays">
    <div>
        <label for="node-input-holiday-container-row"><i class="fa fa-list"></i> <span data-i18n="german-holidays.label.holidayList"></span></label>
        <div class="node-input-holiday-container-row">
            <ol id="node-input-holiday-container" class="node-input-holiday-container"></ol>
            <button type="button" id="node-button-btnHolidayAdd" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]german-holidays.placeholder.btnHolidayAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="german-holidays.label.btnHolidayAdd"></span></button> &nbsp;
            <button type="button" id="node-button-btnHolidayClear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]german-holidays.placeholder.btnHolidayClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="german-holidays.label.btnHolidayClear"></span></button> &nbsp;
            <select type="text" id="node-regionSel"  class="rdg-ui-btn red-ui-button" data-i18n="[title]german-holidays.placeholder.btnHolidayAddPre" style="margin-top: 4px;width:200px">
            </select>
            <button type="button" id="node-button-btnHolidayAddPre"  class="rdg-ui-btn red-ui-button" data-i18n="[title]german-holidays.placeholder.btnHolidayAddPre" style="margin-top: 4px;"><i class="fa fa-plus-square"></i> <span data-i18n="german-holidays.label.btnHolidayAddPre"></span></button>
        </div>
        <input type="hidden" id="node-input-region">
    </div>

    <div class="form-row form-tips" data-i18n="[html]german-holidays.tips.holiday"></div>

    <hr>
    <div>
        <label for="node-input-specialday-container-row"><i class="fa fa-list"></i> <span data-i18n="german-holidays.label.specialdayList"></span></label>
        <div class="node-input-specialday-container-row">
            <ol id="node-input-specialday-container" class="node-input-specialday-container"></ol>
            <button type="button" id="node-button-btnSpecialdayAdd" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]german-holidays.placeholder.btnSpecialdayAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="german-holidays.label.btnSpecialdayAdd"></span></button> &nbsp;
            <button type="button" id="node-button-btnSpecialdayClear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]german-holidays.placeholder.btnSpecialdayClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="german-holidays.label.btnSpecialdayClear"></span></button> &nbsp;
            <button type="button" id="node-button-btnSpecialdayAddPre" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]german-holidays.placeholder.btnSpecialdayAddPre" style="margin-top: 4px;"><i class="fa fa-plus-circle"></i> <span data-i18n="german-holidays.label.btnSpecialdayAddPre"></span></button>
        </div>
    </div>

    <div class="form-tips" data-i18n="[html]german-holidays.tips.specialday"></div>

    <hr>
    <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]node-red:common.label.topic">
    </div>
    <div class="form-row" data-i18n="[title]node-red:common.label.name">
        <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>

    <div id="dialog-edit-day" class="red-ui-editor">
        <div class="form-row">
            <label for="dialog-input-id">includes</label>
            <input type="text" name="dialog-input-id" id="dialog-input-id" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="dialog-input-name">name</label>
            <input type="text" name="dialog-input-name" id="dialog-input-name" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="dialog-input-nameAlt">name alternate</label>
            <input type="text" name="dialog-input-nameAlt" id="dialog-input-nameAlt" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row">
            <label for="dialog-input-character">character</label>
            <select type="text" id="dialog-input-character" name="dialog-input-character" style="width:70%" >
            </select>
        </div>
        <div class="form-row">
            <label for="dialog-input-date-type">type</label>
            <select type="text" id="dialog-input-date-type" name="dialog-input-date-type" style="width:70%" >
            </select>
        </div>

        <div class="form-row dialog-input-date-row">
            <label for="dialog-input-date">date</label>
            <input type="text" name="dialog-input-date" id="dialog-input-date" min="1" max="31" step="1" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row dialog-input-daysRel-row">
            <label for="dialog-input-daysRel">days</label>
            <input type="number" name="dialog-input-daysRel" id="dialog-input-daysRel" min="-370" max="370" step="1" class="text ui-widget-content ui-corner-all">
        </div>
        <div class="form-row dialog-input-month-row">
            <label for="dialog-input-month">month</label>
            <select type="text" id="dialog-input-month" name="dialog-input-month" class="text ui-widget-content ui-corner-all" style="width:70%" >
            </select>
        </div>
        <div class="form-row dialog-input-dowRel-row">
            <label for="dialog-input-nthdow">relative</label>
            <input type="number" id="dialog-input-nthdow" name="dialog-input-nthdow" min="1" max="5" step="1" class="text ui-widget-content ui-corner-all" style="width:30%">
            <select type="text" id="dialog-input-dayofweek" name="dialog-input-dayofweek" style="width:40%" >
            </select>
        </div>
        <div class="form-row">
            <label for="dialog-input-payload">add. payload</label>
            <input type="text" name="dialog-input-payload" id="dialog-input-payload" class="text ui-widget-content ui-corner-all">
        </div>
        <div>
            <label id="dialog-label-date-out"></label>
        </div>
    </div>
</script>


<!-- Next, some simple help text is provided for the node. -->
<script type="text/html" data-help-name="german-holidays">
    <body>
    <h3>About</h3>
    <p>Gets german holidays</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">any</span>
        </dt>
        <dd> the payload is not used. </dd>

        <dt>region <span class="property-type">region</span></dt>
        <dd> the region which should be used for getting holidays. Could also be defined in the configuration of the node. This property must be a string of two letters with the german state shortcut (BY=Bayern, BE=Berlin, ...).</dd>

        <dt class="optional">ts <span class="property-type">number</span></dt>
        <dd> defines a timestamp for the source of the data. if not defined today will be used.</dd>

        <dt class="optional">day <span class="property-type">number</span></dt>
        <dd> if defined only the Holiday information will get the relative to the timestamp (today by default). So if `msg.ts` is not defined, `msg.day = 0` is today, `msg.day = -1` is yesterday; `msg.day = 1` is tomorow, ...</dd>

        <dt class="optional">date <span class="property-type">Date</span></dt>
        <dd> if defined only the Holiday information for the defined date will given.</dd>
    </dl>

 <h3>Outputs</h3>
     <ol class="node-ports">
         <li>Standard output
             <dl class="message-properties">
                 <dt>payload <span class="property-type">object</span></dt>
                 <dd>if no `day` or `date` parameter is given, with a lot of holiday information</dd>
             </dl>
         </li>
     </ol>
     <h3>payload output properties</h3>
     <h4>day-object</h4>
     <p>if the input property day or date was set, the payload is only a day object with the following properties. Otherwhise the payload is a more complex object for different days which are of type day-object (see below).</p>
     <dl class="message-properties">
            <dt>id <span class="property-type">string</span></dt>
            <dd> an id of the object (is the english name in upper case)</dd>

            <dt>name <span class="property-type">number</span></dt>
            <dd> name of the day (in german).</dd>

            <dt>dayOfWeek <span class="property-type">number</span></dt>
            <dd> the day of the week, where 1 is monday.</dd>

            <dt>day <span class="property-type">number</span></dt>
            <dd> the day in month of the day</dd>

            <dt>month <span class="property-type">number</span></dt>
            <dd> the month of the day.</dd>

            <dt>year <span class="property-type">number</span></dt>
            <dd> the year of the day.</dd>

            <dt>date <span class="property-type">number</span></dt>
            <dd> the day as javascript date.</dd>

            <dt>dateString <span class="property-type">string</span></dt>
            <dd> the date of the day as string.</dd>

            <dt class="optional">dayOffset <span class="property-type">string</span></dt>
            <dd> the offset to today in days (not every time available).</dd>

            <dt>isSaturday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is saturday.</dd>

            <dt>isSunday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday.</dd>

            <dt>isHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is an holiday.</dd>

            <dt>isWeekend <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday or saturday.</dd>

            <dt>isSunOrHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday or a holiday.</dd>

            <dt>isWeekendOrHoliday <span class="property-type">boolean</span></dt>
            <dd> is true if the day is sunday, saturday or a holiday.</dd>

            <dt class="optional">isBetweenSundayAndHoliday <span class="property-type">string</span></dt>
            <dd> is true if the day is a monday when tuseday is a holiday (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>

            <dt class="optional">isBetweenHolidayAndSaturday <span class="property-type">string</span></dt>
            <dd> is true if the day is a fridey when thursday is a holiday  (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>

            <dt class="optional">isBetweenWeekendOrHoliday <span class="property-type">string</span></dt>
            <dd> is true if the day is not a saturday, sunday or a holiday, but the day before or after is saturday, sunday or a holiday  (only available on standard output for today, tomorrow and dayAfterTomorrow).</dd>
        </dl>
        <h4>payload properties (default)</h4>
            <p>If the input has no day or date property the the payload is an object with the following properties:</p>
            <dl class="message-properties">
             <dt>yesterday <span class="property-type">day-object</span></dt>
             <dd> day-object for the day before today.</dd>

             <dt>today <span class="property-type">day-object</span></dt>
             <dd> day-object for today.</dd>

             <dt>tomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 1 day in the future from today.</dd>

             <dt>dayAfterTomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 2 days in the future from today.</dd>

             <dt>afterTheDayAfterTomorrow <span class="property-type">day-object</span></dt>
             <dd> day-object for the day 3 days in the future from today.</dd>

             <dt>next <span class="property-type">object</span></dt>
             <dd> object representing information about the next holiday.</dd>

             <dt>next.holiday <span class="property-type">day-object</span></dt>
             <dd> object representing the next holiday.</dd>

             <dt>next.holidayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next holiday.</dd>

             <dt>next.weekendDay <span class="property-type">day-object</span></dt>
             <dd> object representing the next saturday or sunday (if it is saturday).</dd>

             <dt>next.weekendDayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next saturday or sunday (if it is saturday).</dd>

             <dt>next.weekendOrHoliday <span class="property-type">day-object</span></dt>
             <dd> object representing the next holiday or saturday or sunday (next free day).</dd>

             <dt>next.weekendOrHolidayDiff <span class="property-type">number</span></dt>
             <dd> count of days until next holiday or saturday or sunday (next free day).</dd>

             <dt>holidays <span class="property-type">day-object</span></dt>
             <dd> An array of objects for every Holiday in the year.</dd>

             <dt>holidays <span class="property-type">array</span></dt>
             <dd> An array of objects for every Holiday in the year.</dd>

             <dt>holidaysNum <span class="property-type">array</span></dt>
             <dd> An array of numbers for every Holiday in the year.</dd>

             <dt>weekNumber <span class="property-type">number</span></dt>
             <dd> weekNumber for today.</dd>

             <dt>weekNumberEven <span class="property-type">boolean</span></dt>
             <dd> true if the weekNumber is even.</dd>
         </dl>
     <h3>Details</h3>
     <p>tbd</p>
     <h3>References</h3>
    <ul>
        <li><a href="https://github.com/Hypnos3/node-red-contrib-german-holidays">GitHub</a> - the nodes github repository</li>
    </ul>
</body>
</script>

<!-- Finally, the node type is registered along with all of its properties   -->
<!-- The example below shows a small subset of the properties that can be set-->
<script type="text/javascript">
    /**
     * get the data od a day
     */
    function getData(rule) {
        return {
            id: rule.find('.node-input-item-id').val(),
            name: rule.find('.node-input-item-name').val(),
            nameAlt: rule.find('.node-input-item-nameAlt').val(),
            character: parseInt(rule.find('.node-input-item-character').val()),
            month: parseInt(rule.find('.node-input-item-month').val()),
            day: parseInt(rule.find('.node-input-item-day').val()),
            nth: parseInt(rule.find('.node-input-item-nth').val()),
            dow: parseInt(rule.find('.node-input-item-dow').val()),
            plType: rule.find('.node-input-item-plType').val(),
            plValue: rule.find('.node-input-item-plValue').val()
        };
    }

    /**
     * save a holiday
     */
    function saveHolidays(node) {
        console.log('saveHolidays'); // eslint-disable-line
        node.holidays = [];
        const holidaysArr = $('#node-input-holiday-container').editableList('items');
        if (holidaysArr) {
            holidaysArr.each(function (_i) {
                const rule = $(this);
                node.holidays.push(getData(rule));
            });
        }
        console.log(node.holidays); // eslint-disable-line
    }

    /**
     * save a special day
     */
    function saveSpecialdays(node) {
        console.log('saveSpecialdays'); // eslint-disable-line
        node.specialdays = [];
        const specialdaysArr = $('#node-input-specialday-container').editableList('items');
        if (specialdaysArr) {
            specialdaysArr.each(function (_i) {
                const rule = $(this);
                node.specialdays.push(getData(rule));
            });
        }
        console.log(node.specialdays); // eslint-disable-line
    }

    /**
     * resizes the list item
     */
    function _edtLstResizeItem(row) {
        const newWidth = row.width() - 10;
        const $name = row.find('.node-input-item-name');
        const $month = row.find('.node-input-item-month');
        const $day = row.find('.node-input-item-day');
        const $btn = row.find('.node-button-item-edit');
        // row1
        $month.width(50);
        $day.width(50);
        const btnWidth = $btn.width();
        $name.width(newWidth - 165 - btnWidth);
    }

    RED.nodes.registerType('german-holidays', {
        category: 'function',
        defaults: {
            name: {
                value: '',
                required: false
            },
            topic: {
                value: '',
                required: false
            },
            region: {
                value: '',
                required: false,
                validate: v => {
                    return (v === '') || (v === null) || (typeof v === 'undefined');
                }
            },
            holidays: {
                value: [],
                required: false
            },
            specialdays: {
                value: [],
                required: false
            }
        },
        inputs: 1, // set the number of inputs - only 0 or 1
        outputs: 1, // set the number of outputs - 0 to n
        icon: 'default.png', // saved in  icons/myicon.png - myicon.png
        color: '#33cc33',
        label() {
            return this.name || 'Holidays';
        },
        labelStyle() {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'Holidays',
        oneditprepare() {
            // #region data
            const allDERegions = [
                'BW',
                'BY',
                'BE',
                'BB',
                'HB',
                'HE',
                'HH',
                'MV',
                'NI',
                'NW',
                'RP',
                'SL',
                'SN',
                'ST',
                'SH',
                'TH',
                'BUND',
                'ALL'
            ];

            const allRegions = [
                'BW',
                'BY',
                'BE',
                'BB',
                'HB',
                'HE',
                'HH',
                'MV',
                'NI',
                'NW',
                'RP',
                'SL',
                'SN',
                'ST',
                'SH',
                'TH',
                'BUND',
                'ALL',
                'A'
            ];

            const easterX = -1;
            const adventX = -2;
            const characteristic = {
                unspecified: 0,
                calendar : 1,
                holiday : 2, // Feiertag
                nationalholiday: 4, // Nationalfeiertag
                birthday: 8, // Geburtstag
                anniversary: 16,
                actionday : 32, // Aktionstag
                customday : 64, // Brauchtumstag
                specialday: 128, // Festtag
                remembranceday: 256, // Gedenktag
                carnival: 512, // Volksfest
                religion: 1024,
                event: 2048, // Veranstaltung
                festival: 4096, // Festspiele, Festival
                meeting: 8196, // Treffen, Tagung, Versammlung
                operation: 16384 // Einsatz
            };

            const allDaysDefinition = {
                NEUJAHRSTAG: {
                    name: 'Neujahrstag', // 1.1.
                    month: 1,
                    day: 1,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                HEILIGEDREIKOENIGE: {
                    name: 'Heilige Drei Könige', // 6.1.
                    nameAlt: 'Epiphanias',
                    month: 1,
                    day: 6,
                    regions: ['BW', 'BY', 'ST', 'ALL', 'A'],
                    character: characteristic.holiday
                },
                VALENTINSTAG: {
                    name: 'Valentinstag', // 14. 2.
                    nameAlt: 'St.-Valentinstag',
                    month: 2,
                    day: 14,
                    regions: [],
                    character: characteristic.specialday
                },
                WEIBERFASTNACHT: {
                    name: 'Weiberfastnacht', // 52 Tage vor dem Ostersonntag
                    nameAlt: 'Schmutziger Donnerstag',
                    month: easterX,
                    day: -52,
                    regions: [],
                    character: characteristic.customday
                },
                ROSENMONTAG: {
                    name: 'Rosenmontag', // 48 Tage vor dem Ostersonntag
                    month: easterX,
                    day: -48,
                    regions: [],
                    character: characteristic.customday
                },
                FASTNACHTSDIENSTAG: {
                    name: 'Fastnachtsdienstag', // 47 Tage vor dem Ostersonntag
                    namerAlt: 'Fastnacht',
                    month: easterX,
                    day: -47,
                    regions: [],
                    character: characteristic.customday
                },
                ASCHERMITTWOCH: {
                    name: 'Aschermittwoch', // 46 Tage vor dem Ostersonntag (der erste Tag der Fastenzeit)
                    month: easterX,
                    day: -46,
                    regions: [],
                    character: characteristic.religion
                },
                WELTFRAUENTAG: {
                    name: 'Weltfrauentag',
                    namerAlt: 'International Women\'s Day',
                    month: 3,
                    day: 8,
                    regions: [],
                    character: characteristic.actionday
                },
                PALMSONNTAG: {
                    name: 'Palmsonntag', // 7 Tage vor dem Ostersonntag
                    month: easterX,
                    day: -7,
                    regions: [],
                    character: characteristic.religion
                },
                GRUENDONNERSTAG: {
                    name: 'Gründonnerstag', // 4 Tage vor dem Ostersonntag
                    month: easterX,
                    day: -3,
                    regions: [],
                    character: characteristic.religion
                },
                KARFREITAG: {
                    name: 'Karfreitag',
                    month: easterX,
                    day: -2,
                    regions: allDERegions,
                    character: characteristic.holiday
                },
                OSTERSONNTAG: {
                    name: 'Ostersonntag',
                    month: easterX,
                    day: 0,
                    regions: ['BB', 'ALL'],
                    character: characteristic.holiday
                },
                OSTERMONTAG: {
                    name: 'Ostermontag',
                    month: easterX,
                    day: 1,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                WEISSERSONNTAG: {
                    name: 'Weißer Sonntag',
                    month: easterX,
                    day: 7,
                    regions: [],
                    character: characteristic.religion
                },
                FRUEHLINGSANFANG: {
                    name: 'meteorologischer Frühlingsanfang', // 1.3. - meteorologischer Frühlingsanfang
                    month: 3,
                    day: 1,
                    regions: [],
                    character: characteristic.calendar
                },
                FRAUENTAG: {
                    name: 'Frauentag', // 8. März - Internationaler Frauentag
                    month: 3,
                    day: 8,
                    regions: [],
                    character: characteristic.actionday
                },
                APRILSCHERZ: {
                    name: '1. April',
                    month: 4,
                    day: 1,
                    regions: [],
                    character: characteristic.customday
                },
                BIERTAG: {
                    name: 'Tag des Deutschen Bieres', // 23. 4.
                    month: 4,
                    day: 23,
                    regions: [],
                    character: characteristic.actionday
                },
                WALPURGISNACHT: {
                    name: 'Walpurgisnacht', // 30. April
                    month: 4,
                    day: 30,
                    regions: [],
                    character: characteristic.customday
                },
                TAG_DER_ARBEIT: {
                    name: 'Maifeiertag', // 1. Mai
                    nameAlt: 'Tag der Arbeit',
                    month: 5,
                    day: 1,
                    regions: allRegions,
                    character: characteristic.remembranceday
                },
                STAR_WARS_TAG: {
                    name: '⭐ Star-Wars',
                    month: 5,
                    day: 4,
                    regions: [],
                    character: characteristic.actionday
                },
                EISHEILIGEN1: {
                    name: 'Eisheiliger Mamertus', // 11. Mai - Bischof von Vienne
                    month: 5,
                    day: 11,
                    regions: [],
                    character: characteristic.religion
                },
                EISHEILIGEN2: {
                    name: 'Eisheiliger Pankratius', // 12. Mai - frühchristlicher Märtyre
                    month: 5,
                    day: 12,
                    regions: [],
                    character: characteristic.religion
                },
                EISHEILIGEN3: {
                    name: 'Eisheiliger Servatius', // 13. Mai - Bischof von Tongeren
                    month: 5,
                    day: 13,
                    regions: [],
                    character: characteristic.religion
                },
                EISHEILIGEN4: {
                    name: 'Eisheiliger Bonifatius', // 14. Mai - frühchristlicher Märtyrer
                    month: 5,
                    day: 14,
                    regions: [],
                    character: characteristic.religion
                },
                EISHEILIGEN5: {
                    name: 'Eisheilige Kalte Sophie', // 15. Mai - frühchristliche Märtyrin und Mutter dreier geweihter Jungfrauen
                    month: 5,
                    day: 15,
                    regions: [],
                    character: characteristic.religion
                },
                MUTTERTAG: {
                    name: 'Muttertag', // 2. Sonntag im Mai
                    month: 12 + 5,
                    day: 7, // (1 * 7) + 0,
                    nth: 1, // 0 based
                    dow: 0,
                    regions: [],
                    character: characteristic.actionday
                },
                SOMMERANFANG: {
                    name: 'meteorologischer Sommeranfang', // 1.6. - meteorologische Sommeranfang
                    nameALt: 'Kindertag',
                    month: 6,
                    day: 1,
                    regions: [],
                    character: characteristic.calendar
                },
                CHRISTIHIMMELFAHRT: {
                    name: 'Christi Himmelfahrt',
                    nameAlt: 'Vatertag',
                    month: easterX,
                    day: 39,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                PFINGSTSONNTAG: {
                    name: 'Pfingstsonntag',
                    month: easterX,
                    day: 49,
                    regions: ['BB', 'ALL'],
                    character: characteristic.holiday
                },
                PFINGSTMONTAG: {
                    name: 'Pfingstmontag',
                    month: easterX,
                    day: 50,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                TRINITATIS: {
                    name: 'Trinitatis',
                    nameAlt: 'Dreifaltigkeitssonntag',
                    month: easterX,
                    day: 56,
                    regions: [],
                    character: characteristic.religion
                },
                FRONLEICHNAM: {
                    name: 'Fronleichnam',
                    month: easterX,
                    day: 60,
                    regions: ['BW', 'BY', 'HE', 'NW', 'RP', 'SL', 'ALL', 'A'],
                    character: characteristic.holiday
                },
                GDRINJUSTICE: {
                    name: 'Gedenktag des DDR-Unrechts',
                    nameAlt: 'Aufstand des 17. Juni',
                    month: 6,
                    day: 17,
                    regions: [],
                    character: characteristic.remembranceday
                },
                SOMMERSONNENWENDE: {
                    name: 'Sommersonnenwende', // 21. Juni - kalendarischer Sommeranfang (ändert sich ev. auf 20.Juni)
                    month: 6,
                    day: 21,
                    regions: [],
                    character: characteristic.calendar
                },
                JOHANISTAG: {
                    name: 'Johannistag',
                    month: 6,
                    day: 24,
                    regions: [],
                    character: characteristic.religion
                },
                SIEBENSCHLAEFER: {
                    name: 'Siebenschläfer', // 27. Juni
                    month: 6,
                    day: 27,
                    regions: [],
                    character: characteristic.religion
                },
                MITTJAHR: {
                    name: 'Mittjahrestag',
                    nameAlt: 'Mittjahrstag',
                    month: 7,
                    day: 2,
                    regions: [],
                    character: characteristic.calendar
                },
                FRIEDENSFEST: {
                    name: 'Friedensfest',
                    month: 8,
                    day: 8,
                    regions: [],
                    character: characteristic.religion
                },
                MARIAHIMMELFAHRT: {
                    name: 'Mariä Himmelfahrt',
                    month: 8,
                    day: 15,
                    regions: ['SL', 'BY', 'ALL', 'A'],
                    character: characteristic.religion
                },
                HERBSTANFANG: {
                    name: 'meteorologischer Herbstanfang', // 1.9. - meteorologischer Herbstanfang
                    month: 9,
                    day: 1,
                    regions: [],
                    character: characteristic.calendar
                },
                WELTKINDERTAG: {
                    name: 'Weltkindertag',
                    month: 9,
                    day: 20,
                    regions: ['TH', 'ALL'],
                    character: characteristic.customday
                },
                MICHAELISTAG: {
                    name: 'Michaelistag', // Tag Erzengels Michael und aller Engel
                    month: 9,
                    day: 29,
                    regions: [],
                    character: characteristic.religion
                },
                ERNTEDANK: {
                    name: 'Erntedank', // erster Sonntag im Oktober
                    month: 12 + 10,
                    day: 0, // (0 * 7) + 0, // old= 1,
                    nth: 0, // 0 based
                    dow: 0,
                    regions: [],
                    character: characteristic.religion
                },
                DEUTSCHEEINHEIT: {
                    name: 'Tag der Deutschen Einheit',
                    month: 10,
                    day: 3,
                    regions: allDERegions,
                    character: characteristic.nationalholiday
                },
                KIRCHWEIH: {
                    name: 'Kirchweih',
                    nameAlt: 'Allerweltskirchweih', // 3. Sonntag Oktober
                    month: 12 + 10,
                    day: 14, // (2 * 7) + 0
                    nth: 2, // 0 based
                    dow: 0,
                    regions: [],
                    character: characteristic.holiday
                },
                NATIONALFEIERTAG: {
                    name: 'Nationalfeiertag', // 26. Oktober
                    month: 10,
                    day: 26,
                    regions: ['A'],
                    character: characteristic.holiday
                },
                REFORMATIONSTAG: {
                    name: 'Reformationstag', // 31. Oktober
                    nameAlt: 'Halloween',
                    month: 10,
                    day: 31,
                    regions: ['BB', 'MV', 'SN', 'ST', 'TH', 'ALL'],
                    character: characteristic.holiday
                },
                ALLERHEILIGEN: {
                    name: 'Allerheiligen',
                    month: 11,
                    day: 1,
                    regions: ['BW', 'BY', 'NW', 'RP', 'SL', 'ALL', 'A'],
                    character: characteristic.holiday
                },
                ALLERSEELEN: {
                    name: 'Allerseelen', // 2. November
                    month: 11,
                    day: 2,
                    regions: [],
                    character: characteristic.religion
                },
                MARTINSTAG: {
                    name: 'Martinstag', // 11. November
                    month: 11,
                    day: 11,
                    regions: [],
                    character: characteristic.religion
                },
                VOLKSTRAUERTAG: {
                    name: 'Volkstrauertages', // Sonntag (3 Tage) vor dem Buß- und Bettag
                    month: adventX,
                    day: -35,
                    regions: [],
                    character: characteristic.remembranceday
                },
                BUBETAG: {
                    name: 'Buß- und Bettag',
                    month: adventX,
                    day: -32,
                    regions: ['SN', 'ALL'],
                    character: characteristic.religion
                },
                TOTENSONNTAG: {
                    name: 'Totensonntag', // Sonntag (4 Tage) nach dem Buß- und Bettag; eine Woche vor dem ersten Advent
                    nameAlt: 'Ewigkeitssonntag',
                    month: adventX,
                    day: -28,
                    regions: [],
                    character: characteristic.religion
                },
                ADVENT1: {
                    name: 'erste Advent', // vierte Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 1. Advent liegen 11 Tage
                    month: adventX,
                    day: -21,
                    regions: [],
                    character: characteristic.religion
                },
                ADVENT2: {
                    name: 'zweite Advent', // dritte Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 2. Advent liegen 18 Tage
                    month: adventX,
                    day: -14,
                    regions: [],
                    character: characteristic.religion
                },
                WINTERANFANG: {
                    name: 'meteorologischer Winteranfang', // 1.9. - meteorologischer Winteranfang
                    month: 12,
                    day: 1,
                    regions: [],
                    character: characteristic.calendar
                },
                NIKOLAUS: {
                    name: 'Nikolaus', // 6.12.
                    month: 12,
                    day: 6,
                    regions: [],
                    character: characteristic.religion
                },
                MARIAEMPFAENGNIS: {
                    name: 'Mariä Empfängnis', // 6.12.
                    month: 12,
                    day: 8,
                    regions: ['A'],
                    character: characteristic.religion
                },
                NOBELPREIS: {
                    name: 'Nobelpreis',
                    month: 12,
                    day: 10,
                    regions: [],
                    character: characteristic.actionday
                },
                ADVENT3: {
                    name: 'dritte Advent', // zweite Sonntag vor Weihnachten; Zwischen Buss und Bettag und dem 3. Advent liegen 25 Tage
                    month: adventX,
                    day: -7,
                    regions: [],
                    character: characteristic.religion
                },
                ADVENT4: {
                    name: 'vierte Advent', // Sonntag direkt vor Weihnachten; Zwischen Buss und Bettag und dem 4. Advent liegen 32 Tage
                    month: adventX,
                    day: 0,
                    regions: [],
                    character: characteristic.religion
                },
                WINTERSONNENWENDE: {
                    name: 'Wintersonnenwende', // 21.12. - kalendarischer Winteranfang
                    month: 12,
                    day: 22,
                    regions: [],
                    character: characteristic.calendar
                },
                HEILIGABEND: {
                    name: 'Heiligabend',
                    nameAlt: 'Weihnachtsabend',
                    month: 12,
                    day: 24,
                    regions: [],
                    character: characteristic.religion
                },
                ERSTERWEIHNACHTSFEIERTAG: {
                    name: '1. Weihnachtstag',
                    nameAlt: 'Christtag',
                    month: 12,
                    day: 25,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                ZWEITERWEIHNACHTSFEIERTAG: {
                    name: '2. Weihnachtstag',
                    nameAlt: 'Stefanitag',
                    month: 12,
                    day: 26,
                    regions: allRegions,
                    character: characteristic.holiday
                },
                SILVESTER: {
                    name: 'Silvester', // 31.12.
                    month: 12,
                    day: 31,
                    regions: [],
                    character: characteristic.calendar
                }
            };
            // #endregion data
            const node = this;
            $('.rdg-ui-btn').button(); // ui-button ui-widget ui-corner-all

            // #region generic DateTimeFunctions
            /**
             * calculates the easter date
             */
            function _getEasterDate(year) {
                const C = Math.floor(year / 100);
                const N = year - 19 * Math.floor(year / 19);
                const K = Math.floor((C - 17) / 25);
                let I = C - Math.floor(C / 4) - Math.floor((C - K) / 3) + 19 * N + 15;
                I -= 30 * Math.floor(I / 30);
                I -=
                    Math.floor(I / 28) *
                    (1 -
                        Math.floor(I / 28) *
                        Math.floor(29 / (I + 1)) *
                        Math.floor((21 - N) / 11));
                let J = year + Math.floor(year / 4) + I + 2 - C + Math.floor(C / 4);
                J -= 7 * Math.floor(J / 7);
                const L = I - J;
                const M = 3 + Math.floor((L + 40) / 44);
                const D = L + 28 - 31 * Math.floor(M / 4);
                return new Date(Date.UTC(year, M - 1, D));
            }

            /**
             * Calculates the 4th Advent date of a given year.
             * @param year {number}
             * @returns {Date} 4th Advent date
             * @private
             */
            function _getAdvent4th(year) {
                const date = _makeDate(year, 12, 25);
                const offset = ((date.getDay() % 7) || 7);
                return _makeDate(year, date, -offset);
            }
            /**
             * get a date for the specific day of week in the given month
             * @param {number} year year to check
             * @param {number} month month to check
             * @param {number} dayOfWeek day of week 0=Sunday, 1=Monday, ..., 6=Saturday
             * @param {number} n the nTh Numer of the day of week - 0 basiert
             */
            function _firstNthWeekdayOfMonth(year, month, dayOfWeek, n) {
                console.log(`_firstNthWeekdayOfMonth year=${year} month=${month} dayOfWeek=${dayOfWeek} nth=${n}`); // eslint-disable-line
                const date = new Date(year, month, 1);
                const add = (dayOfWeek - date.getDay() + 7) % 7 + n * 7;
                date.setDate(1 + add);
                return date;
            }

            /**
             * get a date for the last specific day of week in the given month
             * @param {number} year year to check
             * @param {number} month month to check
             * @param {number} dayOfWeek day of week 0=Sunday, 1=Monday, ..., 6=Saturday
             * @param {number} n the nTh Numer of the day of week - 0 based
             */
            function _lastNthWeekdayOfMonth(year, month, dayOfWeek, n) {
                console.log(`_lastNthWeekdayOfMonth year=${year} month=${month} dayOfWeek=${dayOfWeek} nth=${n}`); // eslint-disable-line
                const date = new Date(year, month + 1, 0);
                const dy = date.getDay(); // day of week
                if ( dy < dayOfWeek) {
                    dayOfWeek -= 7;
                }
                date.setDate(date.getDate() - (dy - dayOfWeek - n * 7));
                return date;
            }

            /**
             * Creates a new {@link Date}.
             * @param {Number|Date} yearOrRef  -  utc year of the day
             * @param {Number|Date} naturalMonthOrRef  - natural utc month (1-12) or a date object if the new Date should be calculated in realative to the given Date
             * @param {Number} day  - day of month (1 - 31) or if a reference Date is given the number of days as offset from the reference date
             * @returns {Date}  -  new Date
             * @private
             */
            function _makeDate(year, naturalMonthOrRef, day) {
                console.log(`_makeDate year=${year} naturalMonthOrRef=${naturalMonthOrRef} day=${day} `); // eslint-disable-line
                if (typeof year === 'object') {
                    year = year.getUTCFullYear();
                }

                if (typeof naturalMonthOrRef === 'object' && !isNaN(day)) {
                    const date = new Date(naturalMonthOrRef.getTime());
                    date.setDate(date.getDate() + day);
                    return date;
                } else if (isNaN(naturalMonthOrRef) || isNaN(day) || naturalMonthOrRef < 1) {
                    return null;
                }

                if (naturalMonthOrRef >= 13 && naturalMonthOrRef <= 24) {
                    return _firstNthWeekdayOfMonth(year, naturalMonthOrRef - 13, (day % 7), Math.trunc(day / 7));
                }

                if (naturalMonthOrRef >= 25 && naturalMonthOrRef <= 36) {
                    return _lastNthWeekdayOfMonth(year, naturalMonthOrRef - 25, (day % 7), Math.trunc(day / 7));
                }

                if (naturalMonthOrRef <= 12 && day >= 1 && day <= 31) {
                    return new Date(Date.UTC(year, naturalMonthOrRef - 1, day));
                }
                return null;
            }
            // #endregion generic DateTimeFunctions

            // #region list generic functions
            /**
             * pushes an element to an array if not already added.
             * @param {Array} arr  -  array to add element
             * @param {*} el  -  element to add
             */
            function _pushUnique(arr, el) {
                const pos = arr.findIndex(x => {
                    return (el.day === x.day) && (el.month === x.month);
                });
                if (pos > -1) {
                    return;
                }
                arr.push(el);
            }

            /**
             * loads the holiday data
             */
            function _loadHolidays(node) {
                console.log('_loadHolidays'); // eslint-disable-line
                console.log(node.holidays); // eslint-disable-line
                if (node.holidays) {
                    node.holidays.forEach(item => {
                        $('#node-input-holiday-container').editableList('addItem', item);
                    });
                }
            }

            /**
             * adding a holiday
             */
            function _addHolidays(node, region) {
                saveHolidays(node);

                Object.keys(allDaysDefinition).forEach(key => {
                    const d = allDaysDefinition[key];
                    if (d.regions.includes(region)) {
                        _pushUnique(node.holidays, {
                            id: key,
                            name : d.name,
                            nameAlt : d.nameAlt,
                            character: d.character,
                            month: d.month,
                            day: d.day,
                            nth: d.nth,
                            dow: d.dow,
                            plValue: '',
                            plType:'none'
                        });
                    }
                });

                _loadHolidays(node);
            }

            /**
             * loads a special day
             */
            function _loadSpecialdays(node) {
                console.log('loadSpecialdays'); // eslint-disable-line
                console.log(node.specialdays); // eslint-disable-line
                if (node.specialdays) {
                    node.specialdays.forEach(item => {
                        $('#node-input-specialday-container').editableList('addItem', item);
                    });
                }
            }

            /**
             * adding a special day
             */
            function _addSpecialdays(node) {
                saveHolidays(node);
                saveSpecialdays(node);

                Object.keys(allDaysDefinition).forEach(key => {
                    const d = allDaysDefinition[key];
                    const obj = {
                        id: key,
                        name: d.name,
                        nameAlt: d.nameAlt,
                        character: d.character,
                        month: d.month,
                        day: d.day,
                        nth: d.nth,
                        dow: d.dow,
                        plValue: '',
                        plType:'none'
                    };
                    if (!node.holidays.some(e => (e.month === obj.month && e.day === obj.day))) {
                        _pushUnique(node.specialdays, obj);
                    }
                });

                _loadSpecialdays(node);
            }
            // #endregion list generic functions
            // #region container generic
            /**
             * adds an item ti the list
             */
            function _edtLstAddItem(containerRow, containerIndex, data) {
                containerRow.css({ overflow: 'hidden', whiteSpace: 'nowrap' });
                const row = $('<div/>').appendTo(containerRow);
                // row1
                // id
                $('<input/>', {
                    class: 'node-input-item-id',
                    type: 'hidden',
                    value: (data.id || '')
                }).appendTo(row);
                // name
                const $name = $('<input/>', {
                    class: 'node-input-item-name',
                    type: 'text',
                    value: (data.name || ''),
                    title: node._('german-holidays.placeholder.name'),
                    placeholder: node._('german-holidays.placeholder.name')
                }).appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-nameAlt',
                    type: 'hidden',
                    value: (data.nameAlt || '')
                }).appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-character',
                    type: 'hidden',
                    value: (data.character || 0)
                }).appendTo(row);
                // month
                const $month = $('<select/>', {
                    class: 'node-input-item-month',
                    title: node._('german-holidays.placeholder.month')
                });
                $month.appendTo(row);
                for (let index = 1; index <= 12; index++) {
                    $month.append($('<option></option>').val(index).text(node._('german-holidays.month.' + String(index + 11))));
                }
                $month.append($('<option></option>').val(-1).text(node._('german-holidays.label.relEaster')));
                $month.append($('<option></option>').val(-2).text(node._('german-holidays.label.rel4ThAdvent')));
                for (let index = 0; index <= 23; index++) {
                    $month.append($('<option></option>').val(index + 13).text(node._('german-holidays.relday.' + String(index))));
                }
                // day
                const $day = $('<input/>', {
                    class: 'node-input-item-day',
                    type: 'number',
                    value: (isNaN(data.day) ? 1 : data.day),
                    title: node._('german-holidays.placeholder.day'),
                    placeholder: node._('german-holidays.placeholder.day')
                });
                $day.appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-nth',
                    type: 'hidden',
                    value: (Math.trunc(data.day / 7) || 0)
                }).appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-dow',
                    type: 'hidden',
                    value: ((data.day % 7) || 0)
                }).appendTo(row);
                // other
                $('<input/>', {
                    class: 'node-input-item-plValue',
                    type: 'hidden',
                    value: (data.plValue || '')
                }).appendTo(row);
                $('<input/>', {
                    class: 'node-input-item-plType',
                    type: 'hidden',
                    value: (data.plType || 'none')
                }).appendTo(row);
                // edit Button
                // <a id="node-config-lookup-ipaddress" class="btn"><i id="node-config-lookup-ipaddress-icon" class="fa fa-search"></i></a>
                const $btn = $('<a />', {
                    class: 'node-button-item-edit btn ui-button ui-widget ui-corner-all'
                }).append('<i class= "fa fa-pencil-square-o" >').appendTo(row);
                // set day
                $month.change(() => {
                    const month = $month.val();
                    if (month >= 1 && month <= 12) {
                        $day.attr({
                            'max' : 31,
                            'min' : 1,
                            'step' : 1
                        });
                    } else if (month < 1) {
                        $day.attr({
                            'max' : 370,
                            'min' : -370,
                            'step' : 1
                        });
                    } else {
                        $day.prop('disabled', true);
                    }
                });
                $month.val(isNaN(data.month) ? 1 : data.month);
                $month.change();
                if (data.id || data.nameAlt || data.character) {
                    $name.prop( 'disabled', true );
                }
                $btn.button();
                $btn.click(() => {
                    _dialogLoadData(row);
                });

                _edtLstResizeItem(containerRow);
            }
            // #endregion container generic
            // #region holiday-container
            $('#node-input-holiday-container').css('min-height', '200px').css('min-width', '200px').editableList({
                addItem: _edtLstAddItem,
                sortItems(holidays) {
                    holidays = $('#node-input-holiday-container').editableList('items');
                    holidays.each(function (i) {
                        $(this).find('.node-input-holiday-index').html(i + 1);
                    });
                },
                resizeItem: _edtLstResizeItem,
                addButton: false,
                sortable: true,
                removable: true,
                scrollOnAdd: true,
                connectWith: $('#node-input-specialday-container')
            });
            // #endregion holiday-container
            // #region specialday-container
            $('#node-input-specialday-container').css('min-height', '200px').css('min-width', '200px').editableList({
                addItem: _edtLstAddItem,
                resizeItem: _edtLstResizeItem,
                addButton: false,
                sortable: true,
                removable: true,
                scrollOnAdd: true,
                connectWith: $('#node-input-holiday-container')
            });
            // #endregion specialday-container

            // #region migrate and load
            const oldValue = $('#node-input-region').val();
            if (oldValue && oldValue !== '') {
                // Backward compatibility
                _addHolidays(node, oldValue);
                $('#node-input-region').val('');
            }
            // #endregion migrate

            // #region dialog
            const year = (new Date()).getUTCFullYear();
            const easter_date = _getEasterDate(year);
            const advent4th_date = _getAdvent4th(year);

            const year_next = year + 1;
            const easter_date_next = _getEasterDate(year_next);
            const advent4th_date_next = _getAdvent4th(year_next);

            let $dialogConnFields = {};
            const $dialogId = $('#dialog-input-id');
            const $dialogName = $('#dialog-input-name');
            const $dialogNameAlt = $('#dialog-input-nameAlt');
            const $dialogCharacter = $('#dialog-input-character');
            const $dialogDateType = $('#dialog-input-date-type');
            const $dialogDate = $('#dialog-input-date');
            const $dialogMonth = $('#dialog-input-month');
            const $dialogNthdow = $('#dialog-input-nthdow');
            const $dialogDayofweek = $('#dialog-input-dayofweek');
            const $dialogPayload = $('#dialog-input-payload');

            const $dialogDaysRel = $('#dialog-input-daysRel');
            const $dialogLabel = $('#dialog-label-date-out');


            $dialogPayload.typedInput({
                default: 'none',
                types: [
                    {
                        value:'none',
                        label:'N/A',
                        hasValue:false
                    },
                    'msg',
                    'flow',
                    'global',
                    'str',
                    'num',
                    'bool',
                    'json',
                    'bin',
                    'date',
                    'env']
            });

            /**
             * Loads the data into the dialog
             */
            function _dialogLoadData(rule) {
                $dialogConnFields = rule;
                $dialogId.val(rule.find('.node-input-item-id').val());
                $dialogName.val(rule.find('.node-input-item-name').val());
                $dialogNameAlt.val(rule.find('.node-input-item-nameAlt').val());
                $dialogCharacter.val(rule.find('.node-input-item-character').val());
                $dialogDaysRel.val(rule.find('.node-input-item-day').val());

                const month = parseInt(rule.find('.node-input-item-month').val());
                const day = parseInt($dialogDaysRel.val());
                $dialogNthdow.val(String(Math.trunc(day / 7) + 1));
                $dialogDayofweek.val(String(day % 7));
                $dialogDate.datepicker('setDate', null);
                $dialogMonth.val('1');

                $dialogPayload.typedInput('type',(rule.find('.node-input-item-plType').val() || 'none'));
                $dialogPayload.typedInput('value',(rule.find('.node-input-item-plValue').val() || ''));

                if (month >= 1 && month <= 12) {
                    $dialogDateType.val('date');
                    const date = new Date();
                    date.setUTCHours(0,0,0,0);
                    date.setUTCMonth(month - 1,day);
                    $dialogDate.datepicker('setDate', date);
                } else if (month >= 13 && month <= 24) {
                    $dialogDateType.val('weekdayfirst');
                    $dialogMonth.val(String(month - 12));
                } else if (month >= 25 && month <= 36) {
                    $dialogDateType.val('weekdaylast');
                    $dialogMonth.val(String(month - 24));
                } else if (month === -1) {
                    $dialogDateType.val('easter');
                    $dialogMonth.val('-1');
                } else if (month === -2) {
                    $dialogDateType.val('advent');
                    $dialogMonth.val('-2');
                } else {
                    $dialogDateType.val('date');
                    $dialogDate.datepicker('setDate', null);
                }
                $dialogDateType.change();
                $dialog.dialog('open');
            }

            /**
             * Saves the Dialog Data
             */
            function _dialogSaveData() {
                console.log('dialogSaveData'); // eslint-disable-line

                $dialogConnFields.find('.node-input-item-id').val($dialogId.val());
                $dialogConnFields.find('.node-input-item-name').val($dialogName.val());
                $dialogConnFields.find('.node-input-item-nameAlt').val($dialogNameAlt.val());
                $dialogConnFields.find('.node-input-item-character').val($dialogCharacter.val());
                $dialogConnFields.find('.node-input-item-plType').val($dialogPayload.typedInput('type'));
                $dialogConnFields.find('.node-input-item-plValue').val($dialogPayload.typedInput('value'));
                switch ($dialogDateType.val()) {
                    case 'easter':
                        $dialogConnFields.find('.node-input-item-month').val('-1');
                        $dialogConnFields.find('.node-input-item-day').val($dialogDaysRel.val());
                        break;
                    case 'advent':
                        $dialogConnFields.find('.node-input-item-month').val('-2');
                        $dialogConnFields.find('.node-input-item-day').val($dialogDaysRel.val());
                        break;
                    case 'weekdayfirst': {
                        $dialogConnFields.find('.node-input-item-month').val(String(parseInt($dialogMonth.val()) + 12));
                        const nth = (parseInt($dialogNthdow.val()) - 1);
                        $dialogConnFields.find('.node-input-item-nth').val(String(nth));
                        $dialogConnFields.find('.node-input-item-dow').val($dialogDayofweek.val());

                        const val = (nth * 7 + parseInt($dialogDayofweek.val()));
                        $dialogDaysRel.val(String(val));
                        $dialogConnFields.find('.node-input-item-day').val(String(val));
                        break;
                    }
                    case 'weekdaylast': {
                        $dialogConnFields.find('.node-input-item-month').val(String(parseInt($dialogMonth.val()) + 24));
                        const nth = (parseInt($dialogNthdow.val()) - 1);
                        $dialogConnFields.find('.node-input-item-nth').val(String(nth));
                        $dialogConnFields.find('.node-input-item-dow').val($dialogDayofweek.val());

                        const val = (nth * 7 + parseInt($dialogDayofweek.val()));
                        $dialogDaysRel.val(String(val));
                        $dialogConnFields.find('.node-input-item-day').val(String(val));
                        break;
                    }
                    default: {
                        const date = $dialogDate.datepicker( 'getDate' );
                        if (date !== null) {
                            $dialogConnFields.find('.node-input-item-month').val(String(date.getUTCMonth() + 1));
                            $dialogConnFields.find('.node-input-item-day').val(date.getUTCDate());
                        }
                    }
                }
                $dialog.dialog( 'close' );
            }

            /**
             * Handles if the data has changed
             */
            function _dialogDateOutChg() {
                let date = null;
                let date2 = null;
                switch ($dialogDateType.val()) {
                    case 'easter': {
                        const val = parseInt($dialogDaysRel.val());
                        date = _makeDate(year, easter_date, val);
                        date2 = _makeDate(year_next, easter_date_next, val);
                        break;
                    }
                    case 'advent': {
                        const val = parseInt($dialogDaysRel.val());
                        date = _makeDate(year, advent4th_date, val);
                        date2 = _makeDate(year_next, advent4th_date_next, val);
                        break;
                    }
                    case 'weekdayfirst': {
                        const val = ((parseInt($dialogNthdow.val()) - 1) * 7 + parseInt($dialogDayofweek.val()));
                        $dialogDaysRel.val(String(val));
                        const month = parseInt($dialogMonth.val()) + 12;
                        date = _makeDate(year, month, val);
                        date2 = _makeDate(year_next, month, val);
                        $("label[for='dialog-input-nthdow']").text(node._('german-holidays.label.dowRelFirst'));
                        break;
                    }
                    case 'weekdaylast': {
                        const val = ((parseInt($dialogNthdow.val()) - 1) * 7 + parseInt($dialogDayofweek.val()));
                        $dialogDaysRel.val(String(val));
                        const month = parseInt($dialogMonth.val()) + 24;
                        date = _makeDate(year, month, val);
                        date2 = _makeDate(year_next, month, val);
                        $("label[for='dialog-input-nthdow']").text(node._('german-holidays.label.dowRelLast'));
                        break;
                    }
                    default: {
                        date = $dialogDate.datepicker('getDate');
                        break;
                    }
                }
                const dlgTitle = node._('german-holidays.label.dialogtitle') + ' [' + $dialogId.val() + ' / ' + $.datepicker.formatDate('yy-mm-dd', date) + ']';
                if (date2) {
                    $dialogLabel.text(node._('german-holidays.label.exampleDate') + ' ' + $.datepicker.formatDate('yy: MM d', date) + ' / ' + $.datepicker.formatDate('yy: MM d', date2));
                } else {
                    $dialogLabel.text(node._('german-holidays.label.exampleDate') + ' ' + $.datepicker.formatDate('MM d (mm-dd)', date));
                }
                $dialog.dialog('option', 'title', dlgTitle);

            }

            $dialogDate.datepicker({
                dateFormat: 'MM d (mm-dd)',
                showOtherMonths: true,
                selectOtherMonths: true,
                changeMonth: true,
                changeYear: false,
                showButtonPanel: true
            });

            Object.keys(characteristic).forEach(key => {
                const c = characteristic[key];
                $dialogCharacter.append($('<option></option>').val(c).text(node._('german-holidays.characteristic.' + key)));
            });

            $dialogDateType.append($('<option></option>').val('date').text(node._('german-holidays.label.date')));
            $dialogDateType.append($('<option></option>').val('easter').text(node._('german-holidays.label.relEaster')));
            $dialogDateType.append($('<option></option>').val('advent').text(node._('german-holidays.label.rel4ThAdvent')));
            $dialogDateType.append($('<option></option>').val('weekdayfirst').text(node._('german-holidays.label.relDayOfWeekFirst')));
            $dialogDateType.append($('<option></option>').val('weekdaylast').text(node._('german-holidays.label.relDayOfWeekLast')));

            for (let index = 1; index <= 12; index++) {
                $dialogMonth.append($('<option></option>').val(index).text(node._('german-holidays.month.' + String(index - 1))));
            }

            for (let index = 0; index <= 6; index++) {
                $dialogDayofweek.append($('<option></option>').val(index).text(node._('german-holidays.days.' + String(index))));
            }

            $("label[for='dialog-input-id']").text(node._('german-holidays.label.id'));
            $("label[for='dialog-input-name']").text(node._('german-holidays.label.name'));
            $("label[for='dialog-input-nameAlt']").text(node._('german-holidays.label.nameAlt'));
            $("label[for='dialog-input-character']").text(node._('german-holidays.label.character'));
            $("label[for='dialog-input-date-type']").text(node._('german-holidays.label.dateType'));
            $("label[for='dialog-input-date']").text(node._('german-holidays.label.date'));
            $("label[for='dialog-input-month']").text(node._('german-holidays.label.month'));
            $("label[for='dialog-input-month']").text(node._('german-holidays.label.month'));
            $("label[for='dialog-input-payload']").text(node._('german-holidays.label.payload'));


            $dialogDateType.change(() => {
                switch ($dialogDateType.val()) {
                    case 'easter':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-dowRel-row').hide();
                        $('.dialog-input-daysRel-row').show();
                        break;
                    case 'advent':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-dowRel-row').hide();
                        $('.dialog-input-daysRel-row').show();
                        break;
                    case 'weekdayfirst':
                    case 'weekdaylast':
                        $('.dialog-input-date-row').hide();
                        $('.dialog-input-month-row').show();
                        $('.dialog-input-dowRel-row').show();
                        $('.dialog-input-daysRel-row').hide();
                        break;
                    default:
                        $('.dialog-input-date-row').show();
                        $('.dialog-input-month-row').hide();
                        $('.dialog-input-dowRel-row').hide();
                        $('.dialog-input-daysRel-row').hide();
                }
                _dialogDateOutChg();
            });
            $dialogId.change(() => { _dialogDateOutChg(); });
            $dialogMonth.change(() => { _dialogDateOutChg(); });
            $dialogDaysRel.change(() => { _dialogDateOutChg(); });
            $dialogNthdow.change(() => { _dialogDateOutChg(); });
            $dialogDayofweek.change(() => { _dialogDateOutChg(); });
            $dialogDate.change(() => { _dialogDateOutChg(); });

            const $dialog = $('#dialog-edit-day').dialog({
                title: node._('german-holidays.label.dialogtitle'),
                autoOpen: false,
                resizable: true,
                height: Math.min(580, $(window).height() * 0.8),
                width: Math.min(530, $(window).width() * 0.8),
                modal: true,
                closeOnEscape: true,
                buttons: {
                    Ok: _dialogSaveData,
                    Cancel() {
                        $dialog.dialog( 'close' );
                    }
                },
                close() {
                    // document.forms["dialog-edit-day-form"].reset();
                    // $dialogForm[0].reset();
                }
            });

            const $dialogForm = $dialog.find( 'form' );
            $dialogForm.on( 'submit', event => {
                event.preventDefault();
                _dialogSaveData();
            });

            // #endregion dialog

            // #region Button
            const $btnHolidayAdd = $('#node-button-btnHolidayAdd');
            $btnHolidayAdd.click(() => {
                $('#node-input-holiday-container').editableList('addItem', {});
            });

            const $btnHolidayClear = $('#node-button-btnHolidayClear');
            $btnHolidayClear.click(() => {
                $('#node-input-holiday-container').editableList('empty');
            });

            const $btnHolidayAddPre = $('#node-button-btnHolidayAddPre');
            $btnHolidayAddPre.click(() => {
                _addHolidays(node, $('#node-regionSel').val());
                $dialog.dialog('close');
            });

            const $selHolidayAddPre = $('#node-regionSel');
            $selHolidayAddPre.append($('<option></option>').val('').text(node._('german-holidays.region.none')));
            allRegions.forEach((_val, _index) => {
                $selHolidayAddPre.append($('<option></option>').val(_val).text(node._('german-holidays.region.' + _val)));
            });
            $selHolidayAddPre.change(() => {
                const b = !$('#node-regionSel').val();
                $btnHolidayAddPre.prop('disabled', b);
                if (b) {
                    $btnHolidayAddPre.hide();
                    $btnHolidayAddPre.button('disable');
                } else {
                    $btnHolidayAddPre.show();
                    $btnHolidayAddPre.button('enable');
                }

            });
            $selHolidayAddPre.change();

            const $btnSpecialdayAdd = $('#node-button-btnSpecialdayAdd');
            $btnSpecialdayAdd.click(() => {
                $('#node-input-specialday-container').editableList('addItem', {});
            });

            const $btnSpecialdayClear = $('#node-button-btnSpecialdayClear');
            $btnSpecialdayClear.click(() => {
                $('#node-input-specialday-container').editableList('empty');
            });

            const $btnSpecialdayAddPre = $('#node-button-btnSpecialdayAddPre');
            $btnSpecialdayAddPre.click(() => {
                _addSpecialdays(node);
                $dialog.dialog('close');
            });
            // #endregion Button

            // #region load data
            _loadHolidays(node);
            _loadSpecialdays(node);
            // #endregion load data
        },
        oneditsave() {
            const node = this;
            saveHolidays(node);
            saveSpecialdays(node);
        },
        oneditresize(_size) {
            if (typeof $().editableList !== 'undefined') {
                const postrules = $('#node-input-rule-container').editableList('items');
                postrules.each(function(_i) {
                    _edtLstResizeItem($(this));
                });
            }
        }
    });</script>